import React, { useEffect, useMemo, useState } from "react";

// Medispa EPV Valuation Toolkit (Greenwald)
// Next.js page with TypeScript + TailwindCSS
// No external dependencies required beyond template

// Types
interface ServiceLine {
  id: string;
  name: string;
  price: number; // per unit (annual for memberships)
  volume: number; // annual units (memberships = count of members)
  cogsPct: number; // as decimal 0..1
  kind: "service" | "retail";
}

type EPVMethod = "Owner Earnings" | "NOPAT (EBIT-based)";

type RecommendedMethod =
  | "EPV Only"
  | "Asset Reproduction"
  | "Conservative: Min"
  | "Opportunistic: Max"
  | "Blend: 70% EPV / 30% Asset";

// Helpers
const clamp = (v: number, min: number, max: number) => Math.min(max, Math.max(min, v));
const fmt = new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 });
const fmt2 = new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 2 });
const pct = (v: number) => `${(v * 100).toFixed(1)}%`;

function percentile(sorted: number[], p: number) {
  if (sorted.length === 0) return 0;
  const idx = clamp(Math.floor((sorted.length - 1) * p), 0, sorted.length - 1);
  return sorted[idx];
}

function normalRand(mean: number, sd: number) {
  // Box-Muller
  let u = 0, v = 0;
  while (u === 0) u = Math.random();
  while (v === 0) v = Math.random();
  const n = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
  return mean + sd * n;
}

function classNames(...arr: (string | false | null | undefined)[]) {
  return arr.filter(Boolean).join(" ");
}

export default function MedispaEPVPage() {
  // UI State
  const [activeTab, setActiveTab] = useState<
    "inputs" | "model" | "valuation" | "analytics" | "montecarlo" | "lbo" | "notes"
  >("inputs");

  // Service lines (defaults tailored for a mature U.S. medispa)
  const [serviceLines, setServiceLines] = useState<ServiceLine[]>([
    { id: "inj", name: "Injectables", price: 575, volume: 2200, cogsPct: 0.28, kind: "service" },
    { id: "laser", name: "Laser / Devices", price: 350, volume: 1800, cogsPct: 0.10, kind: "service" },
    { id: "aesth", name: "Aesthetics / Facials", price: 200, volume: 1200, cogsPct: 0.15, kind: "service" },
    { id: "retail", name: "Retail / Skincare", price: 90, volume: 3000, cogsPct: 0.55, kind: "retail" },
    { id: "memb", name: "Memberships (annual)", price: 1188, volume: 400, cogsPct: 0.05, kind: "service" },
    { id: "other", name: "Other", price: 150, volume: 400, cogsPct: 0.10, kind: "service" },
  ]);

  // Direct clinical labor (commission/wages) applied to service lines (excludes retail)
  const [clinicalLaborPct, setClinicalLaborPct] = useState(0.28);

  // Operating expenses
  const [marketingPct, setMarketingPct] = useState(0.08);
  const [adminPct, setAdminPct] = useState(0.12);
  const [rentAnnual, setRentAnnual] = useState(156000); // $13k/mo
  const [medDirectorAnnual, setMedDirectorAnnual] = useState(36000);
  const [insuranceAnnual, setInsuranceAnnual] = useState(18000);
  const [softwareAnnual, setSoftwareAnnual] = useState(24000);
  const [utilitiesAnnual, setUtilitiesAnnual] = useState(18000);
  const [otherOpexPct, setOtherOpexPct] = useState(0.02);

  // Normalizations & non-cash
  const [ownerAddBack, setOwnerAddBack] = useState(120000);
  const [otherAddBack, setOtherAddBack] = useState(0);
  const [daAnnual, setDaAnnual] = useState(80000); // Depreciation & Amortization

  // Maintenance capex (choose as percent of revenue or flat amount)
  const [capexMode, setCapexMode] = useState<"percent" | "amount">("percent");
  const [maintenanceCapexPct, setMaintenanceCapexPct] = useState(0.04);
  const [maintenanceCapexAmount, setMaintenanceCapexAmount] = useState(120000);

  // Working capital profile (for reproduction value estimation)
  const [dsoDays, setDsoDays] = useState(5);
  const [dsiDays, setDsiDays] = useState(40);
  const [dpoDays, setDpoDays] = useState(30);

  // Capital & financing
  const [cashNonOperating, setCashNonOperating] = useState(200000);
  const [debtInterestBearing, setDebtInterestBearing] = useState(1200000);

  // Tax & WACC
  const [taxRate, setTaxRate] = useState(0.25);
  const [rfRate, setRfRate] = useState(0.042); // Risk-free
  const [erp, setErp] = useState(0.055); // Equity risk premium
  const [beta, setBeta] = useState(1.1);
  const [sizePrem, setSizePrem] = useState(0.02);
  const [specificPrem, setSpecificPrem] = useState(0);
  const [costDebt, setCostDebt] = useState(0.085);
  const [targetDebtWeight, setTargetDebtWeight] = useState(0.35);

  // EPV method and recommendation settings
  const [epvMethod, setEpvMethod] = useState<EPVMethod>("Owner Earnings");
  const [recoMethod, setRecoMethod] = useState<RecommendedMethod>("EPV Only");

  // Asset reproduction inputs
  const [buildoutImprovements, setBuildoutImprovements] = useState(700000);
  const [equipmentDevices, setEquipmentDevices] = useState(500000);
  const [ffne, setFfne] = useState(150000);
  const [startupIntangibles, setStartupIntangibles] = useState(120000); // licensing, recruiting, training, branding
  const [otherRepro, setOtherRepro] = useState(0);

  // Scenario quick toggles
  const [scenario, setScenario] = useState<"Base" | "Bull" | "Bear">("Base");

  // Monte Carlo
  const [mcRuns, setMcRuns] = useState(500);
  const [mcStats, setMcStats] = useState<null | {
    mean: number; median: number; p5: number; p95: number; meanEquity: number; p5Equity: number; p95Equity: number;
  }>(null);

  // Local storage persistence (SSR safe)
  useEffect(() => {
    if (typeof window === "undefined") return;
    try {
      const raw = window.localStorage.getItem("medispa-epv-state");
      if (raw) {
        const parsed = JSON.parse(raw);
        // Defensive parsing: only set known keys
        Object.entries(parsed).forEach(([k, v]) => {
          // @ts-ignore
          if (k in defaultStateSnapshot) defaultStateSnapshot[k] = v;
        });
      }
    } catch {}
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Persist
  useEffect(() => {
    if (typeof window === "undefined") return;
    const snapshot = collectStateSnapshot();
    window.localStorage.setItem("medispa-epv-state", JSON.stringify(snapshot));
  });

  // State snapshot helpers
  const defaultStateSnapshot: Record<string, any> = {};
  function collectStateSnapshot() {
    return {
      serviceLines,
      clinicalLaborPct,
      marketingPct,
      adminPct,
      rentAnnual,
      medDirectorAnnual,
      insuranceAnnual,
      softwareAnnual,
      utilitiesAnnual,
      otherOpexPct,
      ownerAddBack,
      otherAddBack,
      daAnnual,
      capexMode,
      maintenanceCapexPct,
      maintenanceCapexAmount,
      dsoDays,
      dsiDays,
      dpoDays,
      cashNonOperating,
      debtInterestBearing,
      taxRate,
      rfRate,
      erp,
      beta,
      sizePrem,
      specificPrem,
      costDebt,
      targetDebtWeight,
      epvMethod,
      recoMethod,
      buildoutImprovements,
      equipmentDevices,
      ffne,
      startupIntangibles,
      otherRepro,
      scenario,
      mcRuns,
    };
  }

  // Scenario adjustments (non-destructive, applied to computed values)
  const scenarioAdj = useMemo(() => {
    if (scenario === "Bull") return { revenue: 1.08, ebitAdj: 1.05, waccAdj: -0.01 };
    if (scenario === "Bear") return { revenue: 0.92, ebitAdj: 0.95, waccAdj: 0.01 };
    return { revenue: 1.0, ebitAdj: 1.0, waccAdj: 0.0 };
  }, [scenario]);

  // Derived computations
  const revenueByLine = useMemo(() => serviceLines.map(l => l.price * l.volume), [serviceLines]);
  const totalRevenueBase = useMemo(() => revenueByLine.reduce((a, b) => a + b, 0), [revenueByLine]);
  const retailRevenue = useMemo(() => serviceLines.filter(l => l.kind === "retail").reduce((a, l) => a + l.price * l.volume, 0), [serviceLines]);
  const serviceRevenue = useMemo(() => totalRevenueBase - retailRevenue, [totalRevenueBase, retailRevenue]);

  const totalCOGS = useMemo(() => serviceLines.reduce((sum, l) => sum + l.price * l.volume * l.cogsPct, 0), [serviceLines]);
  const clinicalLaborCost = useMemo(() => clinicalLaborPct * serviceRevenue, [clinicalLaborPct, serviceRevenue]);

  const grossProfit = useMemo(() => totalRevenueBase - totalCOGS - clinicalLaborCost, [totalRevenueBase, totalCOGS, clinicalLaborCost]);

  const marketingCost = useMemo(() => marketingPct * totalRevenueBase, [marketingPct, totalRevenueBase]);
  const adminCost = useMemo(() => adminPct * totalRevenueBase, [adminPct, totalRevenueBase]);
  const otherOpexCost = useMemo(() => otherOpexPct * totalRevenueBase, [otherOpexPct, totalRevenueBase]);

  const opexTotal = useMemo(() => marketingCost + adminCost + rentAnnual + medDirectorAnnual + insuranceAnnual + softwareAnnual + utilitiesAnnual + otherOpexCost, [marketingCost, adminCost, rentAnnual, medDirectorAnnual, insuranceAnnual, softwareAnnual, utilitiesAnnual, otherOpexCost]);

  const ebitdaReported = useMemo(() => grossProfit - opexTotal, [grossProfit, opexTotal]);
  const ebitdaNormalized = useMemo(() => ebitdaReported + ownerAddBack + otherAddBack, [ebitdaReported, ownerAddBack, otherAddBack]);
  const ebitNormalized = useMemo(() => ebitdaNormalized - daAnnual, [ebitdaNormalized, daAnnual]);
  const ebitMargin = useMemo(() => (totalRevenueBase > 0 ? ebitNormalized / totalRevenueBase : 0), [ebitNormalized, totalRevenueBase]);

  const maintCapex = useMemo(() => (capexMode === "percent" ? maintenanceCapexPct * totalRevenueBase : maintenanceCapexAmount), [capexMode, maintenanceCapexPct, totalRevenueBase, maintenanceCapexAmount]);

  const nopat = useMemo(() => ebitNormalized * (1 - taxRate), [ebitNormalized, taxRate]);
  const ownerEarnings = useMemo(() => nopat + daAnnual - maintCapex, [nopat, daAnnual, maintCapex]);
  const adjustedEarnings = useMemo(() => (epvMethod === "Owner Earnings" ? ownerEarnings : nopat), [epvMethod, ownerEarnings, nopat]);

  // WACC
  const costEquity = useMemo(() => rfRate + beta * erp + sizePrem + specificPrem, [rfRate, beta, erp, sizePrem, specificPrem]);
  const afterTaxCostDebt = useMemo(() => costDebt * (1 - taxRate), [costDebt, taxRate]);
  const baseWacc = useMemo(() => clamp(targetDebtWeight * afterTaxCostDebt + (1 - targetDebtWeight) * costEquity, 0.03, 0.35), [targetDebtWeight, afterTaxCostDebt, costEquity]);
  const scenarioWacc = useMemo(() => clamp(baseWacc + scenarioAdj.waccAdj, 0.03, 0.5), [baseWacc, scenarioAdj]);

  // Scenario-adjusted revenue and earnings
  const totalRevenue = useMemo(() => totalRevenueBase * scenarioAdj.revenue, [totalRevenueBase, scenarioAdj]);
  const ebitScenario = useMemo(() => ebitNormalized * scenarioAdj.ebitAdj * scenarioAdj.revenue, [ebitNormalized, scenarioAdj]);
  const nopatScenario = useMemo(() => ebitScenario * (1 - taxRate), [ebitScenario, taxRate]);
  const maintCapexScenario = useMemo(() => (capexMode === "percent" ? maintenanceCapexPct * totalRevenue : maintCapex), [capexMode, maintenanceCapexPct, totalRevenue, maintCapex]);
  const ownerEarningsScenario = useMemo(() => nopatScenario + daAnnual - maintCapexScenario, [nopatScenario, daAnnual, maintCapexScenario]);
  const adjustedEarningsScenario = useMemo(() => (epvMethod === "Owner Earnings" ? ownerEarningsScenario : nopatScenario), [epvMethod, ownerEarningsScenario, nopatScenario]);

  // EPV (Enterprise and Equity)
  const enterpriseEPV = useMemo(() => (scenarioWacc > 0 ? adjustedEarningsScenario / scenarioWacc : 0), [adjustedEarningsScenario, scenarioWacc]);
  const equityEPV = useMemo(() => enterpriseEPV + cashNonOperating - debtInterestBearing, [enterpriseEPV, cashNonOperating, debtInterestBearing]);

  // Reproduction value (Enterprise)
  const cogsForWC = useMemo(() => totalCOGS + clinicalLaborCost, [totalCOGS, clinicalLaborCost]);
  const ar = useMemo(() => totalRevenue * (dsoDays / 365), [totalRevenue, dsoDays]);
  const inv = useMemo(() => cogsForWC * (dsiDays / 365), [cogsForWC, dsiDays]);
  const ap = useMemo(() => cogsForWC * (dpoDays / 365), [cogsForWC, dpoDays]);
  const nwcRequired = useMemo(() => Math.max(0, ar + inv - ap), [ar, inv, ap]);

  const enterpriseRepro = useMemo(() => buildoutImprovements + equipmentDevices + ffne + startupIntangibles + otherRepro + nwcRequired, [buildoutImprovements, equipmentDevices, ffne, startupIntangibles, otherRepro, nwcRequired]);
  const equityRepro = useMemo(() => enterpriseRepro + cashNonOperating - debtInterestBearing, [enterpriseRepro, cashNonOperating, debtInterestBearing]);

  const franchiseRatio = useMemo(() => (enterpriseRepro > 0 ? enterpriseEPV / enterpriseRepro : 0), [enterpriseEPV, enterpriseRepro]);

  // Recommended equity value based on selected method
  const recommendedEquity = useMemo(() => {
    switch (recoMethod) {
      case "EPV Only":
        return equityEPV;
      case "Asset Reproduction":
        return equityRepro;
      case "Conservative: Min":
        return Math.min(equityEPV, equityRepro);
      case "Opportunistic: Max":
        return Math.max(equityEPV, equityRepro);
      case "Blend: 70% EPV / 30% Asset":
        return 0.7 * equityEPV + 0.3 * equityRepro;
      default:
        return equityEPV;
    }
  }, [recoMethod, equityEPV, equityRepro]);

  const evToRevenue = useMemo(() => (totalRevenue > 0 ? enterpriseEPV / totalRevenue : 0), [enterpriseEPV, totalRevenue]);
  const evToEbitda = useMemo(() => (ebitdaNormalized > 0 ? enterpriseEPV / ebitdaNormalized : 0), [enterpriseEPV, ebitdaNormalized]);

  // Sensitivity table (WACC x EBIT margin)
  const waccRange = useMemo(() => {
    const base = scenarioWacc;
    const arr: number[] = [];
    for (let i = -3; i <= 3; i++) arr.push(clamp(base + i * 0.01, 0.03, 0.5));
    return arr;
  }, [scenarioWacc]);

  const ebitMarginRange = useMemo(() => {
    const base = ebitMargin;
    const arr: number[] = [];
    for (let i = -2; i <= 2; i++) arr.push(clamp(base + i * 0.02, 0, 0.6));
    return arr;
  }, [ebitMargin]);

  function epvAt(ebitMarginGuess: number, waccGuess: number) {
    const ebitGuess = totalRevenue * ebitMarginGuess;
    const nopatGuess = ebitGuess * (1 - taxRate);
    const maint = capexMode === "percent" ? maintenanceCapexPct * totalRevenue : maintCapex; // tie to rev for sensitivity
    const adj = epvMethod === "Owner Earnings" ? nopatGuess + daAnnual - maint : nopatGuess;
    const ev = waccGuess > 0 ? adj / waccGuess : 0;
    return ev + cashNonOperating - debtInterestBearing; // return equity EPV for table
  }

  // Monte Carlo simulation
  function runMonteCarlo() {
    const runs = clamp(Math.floor(mcRuns), 100, 5000);
    const evs: number[] = [];
    const eqs: number[] = [];
    for (let i = 0; i < runs; i++) {
      const wacc = clamp(normalRand(scenarioWacc, 0.01), 0.03, 0.5);
      const rev = Math.max(0, normalRand(totalRevenue, totalRevenue * 0.05));
      const ebitM = clamp(normalRand(ebitMargin, 0.02), 0, 0.6);
      const ebit = rev * ebitM;
      const nop = ebit * (1 - taxRate);
      const maint = capexMode === "percent" ? clamp(normalRand(maintenanceCapexPct, 0.01), 0, 0.2) * rev : maintCapex;
      const adj = epvMethod === "Owner Earnings" ? nop + daAnnual - maint : nop;
      const ev = wacc > 0 ? adj / wacc : 0;
      const eq = ev + cashNonOperating - debtInterestBearing;
      evs.push(ev);
      eqs.push(eq);
    }
    evs.sort((a, b) => a - b);
    eqs.sort((a, b) => a - b);
    setMcStats({
      mean: evs.reduce((a, b) => a + b, 0) / evs.length,
      median: percentile(evs, 0.5),
      p5: percentile(evs, 0.05),
      p95: percentile(evs, 0.95),
      meanEquity: eqs.reduce((a, b) => a + b, 0) / eqs.length,
      p5Equity: percentile(eqs, 0.05),
      p95Equity: percentile(eqs, 0.95),
    });
  }

  // LBO quick check
  const [lboYears, setLboYears] = useState(5);
  const [entryEvOverride, setEntryEvOverride] = useState<number | null>(null);
  const [entryDebtPct, setEntryDebtPct] = useState(0.6);
  const [exitMultipleMode, setExitMultipleMode] = useState<"EPV" | "Same EV">("EPV");

  const entryEV = useMemo(() => (entryEvOverride !== null ? entryEvOverride : enterpriseEPV), [entryEvOverride, enterpriseEPV]);
  const entryDebt = useMemo(() => clamp(entryDebtPct, 0, 0.9) * entryEV, [entryDebtPct, entryEV]);
  const entryEquity = useMemo(() => Math.max(0, entryEV - entryDebt), [entryEV, entryDebt]);

  const lboExitEV = useMemo(() => (exitMultipleMode === "EPV" ? enterpriseEPV : entryEV), [exitMultipleMode, enterpriseEPV, entryEV]);

  const lboSim = useMemo(() => {
    // Simplified: annual owner earnings used to pay interest then principal; no distributions until exit.
    const years = clamp(lboYears, 1, 10);
    let debt = entryDebt;
    const kd = costDebt;
    for (let y = 0; y < years; y++) {
      const interest = debt * kd;
      const fcfToFirm = adjustedEarningsScenario; // approximated constant
      const afterInterest = fcfToFirm - interest;
      const principalPaydown = Math.max(0, afterInterest);
      debt = Math.max(0, debt - principalPaydown);
    }
    const exitEquity = Math.max(0, lboExitEV - debt);
    const moic = entryEquity > 0 ? exitEquity / entryEquity : 0;
    const irr = entryEquity > 0 ? Math.pow(moic, 1 / years) - 1 : 0;
    return { exitDebt: debt, exitEquity, moic, irr };
  }, [lboYears, entryDebt, adjustedEarningsScenario, costDebt, lboExitEV, entryEquity]);

  // UI Components
  function Section({ title, children }: { title: string; children: React.ReactNode }) {
    return (
      <div className="bg-white rounded-xl border border-slate-200 p-6 mb-6 shadow-sm">
        <h2 className="text-lg font-semibold text-slate-800 mb-4">{title}</h2>
        {children}
      </div>
    );
  }

  function LabeledNumber({ label, value, onChange, step = 1, min, max, suffix, prefix, help }: {
    label: string; value: number; onChange: (v: number) => void; step?: number; min?: number; max?: number; suffix?: string; prefix?: string; help?: string;
  }) {
    return (
      <label className="flex flex-col gap-1 text-sm text-slate-700">
        <span className="flex items-center justify-between">
          <span>{label}</span>
          {help ? <span className="text-slate-400">{help}</span> : null}
        </span>
        <div className="flex items-center rounded-lg border border-slate-300 px-3 py-2 bg-white">
          {prefix ? <span className="mr-2 text-slate-500">{prefix}</span> : null}
          <input
            type="number"
            className="w-full outline-none text-slate-900"
            value={Number.isFinite(value) ? value : 0}
            step={step}
            min={min}
            max={max}
            onChange={(e) => onChange(Number(e.target.value))}
          />
          {suffix ? <span className="ml-2 text-slate-500">{suffix}</span> : null}
        </div>
      </label>
    );
  }

  function PercentField(p: { label: string; value: number; onChange: (v: number) => void; step?: number; help?: string }) {
    return <LabeledNumber label={p.label} value={+(p.value * 100).toFixed(4)} onChange={(v) => p.onChange(v / 100)} step={p.step ?? 0.1} suffix="%" help={p.help} />;
  }
  function DollarsField(p: { label: string; value: number; onChange: (v: number) => void; step?: number; help?: string }) {
    return <LabeledNumber label={p.label} value={p.value} onChange={p.onChange} step={p.step ?? 1000} prefix="$" help={p.help} />;
  }

  return (
    <div className="min-h-screen bg-slate-50">
      <div className="max-w-7xl mx-auto px-6 py-8">
        <header className="mb-6">
          <h1 className="text-2xl font-bold text-slate-900">Medispa Earnings Power Valuation (Greenwald)</h1>
          <p className="text-slate-600 mt-1">Real-world EPV model with advanced analytics for private equity-grade valuations of U.S. medispa clinics.</p>
        </header>

        <nav className="flex flex-wrap gap-2 mb-6">
          {[
            { key: "inputs", label: "Inputs" },
            { key: "model", label: "Financial Model" },
            { key: "valuation", label: "Valuation" },
            { key: "analytics", label: "Sensitivity" },
            { key: "montecarlo", label: "Monte Carlo" },
            { key: "lbo", label: "LBO Quick Check" },
            { key: "notes", label: "Notes & Assumptions" },
          ].map((t) => (
            <button
              key={t.key}
              onClick={() => setActiveTab(t.key as any)}
              className={classNames(
                "px-4 py-2 rounded-lg border",
                activeTab === (t.key as any)
                  ? "bg-indigo-600 text-white border-indigo-600"
                  : "bg-white text-slate-700 border-slate-300 hover:bg-slate-100"
              )}
            >
              {t.label}
            </button>
          ))}
        </nav>

        {/* KPI Header */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div className="bg-white rounded-xl border border-slate-200 p-4">
            <div className="text-slate-500 text-sm">Revenue (scenario)</div>
            <div className="text-xl font-semibold text-slate-900">{fmt.format(totalRevenue)}</div>
            <div className="text-slate-500 text-sm">EBIT margin: {pct(ebitMargin)}</div>
          </div>
          <div className="bg-white rounded-xl border border-slate-200 p-4">
            <div className="text-slate-500 text-sm">Enterprise EPV</div>
            <div className="text-xl font-semibold text-emerald-700">{fmt.format(enterpriseEPV)}</div>
            <div className="text-slate-500 text-sm">WACC: {pct(scenarioWacc)}</div>
          </div>
          <div className="bg-white rounded-xl border border-slate-200 p-4">
            <div className="text-slate-500 text-sm">Equity (recommended)</div>
            <div className="text-xl font-semibold text-indigo-700">{fmt.format(recommendedEquity)}</div>
            <div className="text-slate-500 text-sm">Method: {recoMethod}</div>
          </div>
        </div>

        {activeTab === "inputs" && (
          <>
            <Section title="Revenue Builder (Annual)">
              <div className="overflow-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="text-left text-slate-600">
                      <th className="py-2 pr-4">Line</th>
                      <th className="py-2 pr-4">Kind</th>
                      <th className="py-2 pr-4">Price ($)</th>
                      <th className="py-2 pr-4">Volume</th>
                      <th className="py-2 pr-4">COGS %</th>
                      <th className="py-2 pr-4">Revenue</th>
                      <th className="py-2 pr-4">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {serviceLines.map((l, idx) => (
                      <tr key={l.id} className="border-t border-slate-200">
                        <td className="py-2 pr-4">
                          <input
                            className="w-full border border-slate-300 rounded-md px-2 py-1"
                            value={l.name}
                            onChange={(e) => {
                              const copy = [...serviceLines];
                              copy[idx] = { ...l, name: e.target.value };
                              setServiceLines(copy);
                            }}
                          />
                        </td>
                        <td className="py-2 pr-4">
                          <select
                            className="w-full border border-slate-300 rounded-md px-2 py-1"
                            value={l.kind}
                            onChange={(e) => {
                              const copy = [...serviceLines];
                              copy[idx] = { ...l, kind: e.target.value as ServiceLine["kind"] };
                              setServiceLines(copy);
                            }}
                          >
                            <option value="service">Service</option>
                            <option value="retail">Retail</option>
                          </select>
                        </td>
                        <td className="py-2 pr-4">
                          <input
                            type="number"
                            className="w-full border border-slate-300 rounded-md px-2 py-1"
                            value={l.price}
                            step={1}
                            onChange={(e) => {
                              const copy = [...serviceLines];
                              copy[idx] = { ...l, price: Number(e.target.value) };
                              setServiceLines(copy);
                            }}
                          />
                        </td>
                        <td className="py-2 pr-4">
                          <input
                            type="number"
                            className="w-full border border-slate-300 rounded-md px-2 py-1"
                            value={l.volume}
                            step={1}
                            onChange={(e) => {
                              const copy = [...serviceLines];
                              copy[idx] = { ...l, volume: Number(e.target.value) };
                              setServiceLines(copy);
                            }}
                          />
                        </td>
                        <td className="py-2 pr-4">
                          <input
                            type="number"
                            className="w-full border border-slate-300 rounded-md px-2 py-1"
                            value={+(l.cogsPct * 100).toFixed(2)}
                            step={0.5}
                            onChange={(e) => {
                              const copy = [...serviceLines];
                              copy[idx] = { ...l, cogsPct: Number(e.target.value) / 100 };
                              setServiceLines(copy);
                            }}
                          />
                        </td>
                        <td className="py-2 pr-4 text-slate-900">{fmt.format(l.price * l.volume)}</td>
                        <td className="py-2 pr-4">
                          <div className="flex gap-2">
                            <button
                              className="px-3 py-1 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-100"
                              onClick={() => {
                                const copy = [...serviceLines];
                                copy.splice(idx, 1);
                                setServiceLines(copy);
                              }}
                            >
                              Remove
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div className="mt-3 flex items-center justify-between">
                <div className="text-slate-700">Total Revenue: <span className="font-semibold">{fmt.format(totalRevenueBase)}</span></div>
                <button
                  className="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700"
                  onClick={() => {
                    const nid = Math.random().toString(36).slice(2);
                    setServiceLines([
                      ...serviceLines,
                      { id: nid, name: "New Line", price: 100, volume: 100, cogsPct: 0.1, kind: "service" },
                    ]);
                  }}
                >
                  Add Line
                </button>
              </div>
            </Section>

            <Section title="Cost Structure">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <PercentField label="Clinical labor % (services)" value={clinicalLaborPct} onChange={setClinicalLaborPct} help="Commission + provider wages" />
                <PercentField label="Marketing % of revenue" value={marketingPct} onChange={setMarketingPct} />
                <PercentField label="Admin wages % of revenue" value={adminPct} onChange={setAdminPct} />
                <DollarsField label="Rent (annual)" value={rentAnnual} onChange={setRentAnnual} />
                <DollarsField label="Medical director (annual)" value={medDirectorAnnual} onChange={setMedDirectorAnnual} />
                <DollarsField label="Insurance (annual)" value={insuranceAnnual} onChange={setInsuranceAnnual} />
                <DollarsField label="Software (annual)" value={softwareAnnual} onChange={setSoftwareAnnual} />
                <DollarsField label="Utilities (annual)" value={utilitiesAnnual} onChange={setUtilitiesAnnual} />
                <PercentField label="Other opex % of revenue" value={otherOpexPct} onChange={setOtherOpexPct} />
              </div>
            </Section>

            <Section title="Normalizations & Capital Intensity">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <DollarsField label="Owner add-backs" value={ownerAddBack} onChange={setOwnerAddBack} />
                <DollarsField label="Other add-backs" value={otherAddBack} onChange={setOtherAddBack} />
                <DollarsField label="Depreciation & amortization" value={daAnnual} onChange={setDaAnnual} />
                <div className="flex flex-col gap-2">
                  <label className="text-sm text-slate-700">Maintenance capex mode</label>
                  <div className="flex gap-2">
                    <button
                      className={classNames(
                        "px-3 py-2 rounded-lg border",
                        capexMode === "percent"
                          ? "bg-indigo-600 text-white border-indigo-600"
                          : "bg-white text-slate-700 border-slate-300 hover:bg-slate-100"
                      )}
                      onClick={() => setCapexMode("percent")}
                    >
                      Percent of revenue
                    </button>
                    <button
                      className={classNames(
                        "px-3 py-2 rounded-lg border",
                        capexMode === "amount"
                          ? "bg-indigo-600 text-white border-indigo-600"
                          : "bg-white text-slate-700 border-slate-300 hover:bg-slate-100"
                      )}
                      onClick={() => setCapexMode("amount")}
                    >
                      Flat amount
                    </button>
                  </div>
                </div>
                {capexMode === "percent" ? (
                  <PercentField label="Maintenance capex % of revenue" value={maintenanceCapexPct} onChange={setMaintenanceCapexPct} />
                ) : (
                  <DollarsField label="Maintenance capex (annual)" value={maintenanceCapexAmount} onChange={setMaintenanceCapexAmount} />
                )}
                <PercentField label="Effective tax rate" value={taxRate} onChange={setTaxRate} />
              </div>
            </Section>

            <Section title="Capital & WACC">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <DollarsField label="Cash & equivalents (non-operating)" value={cashNonOperating} onChange={setCashNonOperating} />
                <DollarsField label="Interest-bearing debt" value={debtInterestBearing} onChange={setDebtInterestBearing} />
                <div className="flex flex-col gap-2">
                  <label className="text-sm text-slate-700">EPV method</label>
                  <div className="flex gap-2">
                    {["Owner Earnings", "NOPAT (EBIT-based)"] as EPVMethod[]}.map
                    {(["Owner Earnings", "NOPAT (EBIT-based)"] as EPVMethod[]).map((m) => (
                      <button
                        key={m}
                        onClick={() => setEpvMethod(m)}
                        className={classNames(
                          "px-3 py-2 rounded-lg border",
                          epvMethod === m ? "bg-indigo-600 text-white border-indigo-600" : "bg-white text-slate-700 border-slate-300 hover:bg-slate-100"
                        )}
                      >
                        {m}
                      </button>
                    ))}
                  </div>
                </div>
                <PercentField label="Target debt weight (WACC)" value={targetDebtWeight} onChange={setTargetDebtWeight} />
                <PercentField label="Risk-free rate" value={rfRate} onChange={setRfRate} />
                <PercentField label="Equity risk premium" value={erp} onChange={setErp} />
                <LabeledNumber label="Beta (levered)" value={beta} onChange={setBeta} step={0.05} />
                <PercentField label="Size premium" value={sizePrem} onChange={setSizePrem} />
                <PercentField label="Specific risk premium" value={specificPrem} onChange={setSpecificPrem} />
                <PercentField label="Cost of debt (pre-tax)" value={costDebt} onChange={setCostDebt} />
                <div className="bg-slate-50 rounded-lg p-4 border border-slate-200 col-span-1 md:col-span-3">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div>Cost of equity: <span className="font-semibold">{pct(costEquity)}</span></div>
                    <div>After-tax cost of debt: <span className="font-semibold">{pct(afterTaxCostDebt)}</span></div>
                    <div>Base WACC: <span className="font-semibold">{pct(baseWacc)}</span></div>
                  </div>
                </div>
              </div>
            </Section>

            <Section title="Asset Reproduction Inputs">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <DollarsField label="Buildout & improvements" value={buildoutImprovements} onChange={setBuildoutImprovements} />
                <DollarsField label="Devices & equipment" value={equipmentDevices} onChange={setEquipmentDevices} />
                <DollarsField label="FF&E" value={ffne} onChange={setFfne} />
                <DollarsField label="Startup intangibles" value={startupIntangibles} onChange={setStartupIntangibles} />
                <DollarsField label="Other reproduction cost" value={otherRepro} onChange={setOtherRepro} />
                <div className="bg-slate-50 rounded-lg p-4 border border-slate-200">
                  <div className="text-sm text-slate-700">Working capital assumptions</div>
                  <div className="grid grid-cols-3 gap-2 mt-2 text-sm">
                    <LabeledNumber label="DSO (days)" value={dsoDays} onChange={setDsoDays} step={1} />
                    <LabeledNumber label="DSI (days)" value={dsiDays} onChange={setDsiDays} step={1} />
                    <LabeledNumber label="DPO (days)" value={dpoDays} onChange={setDpoDays} step={1} />
                  </div>
                </div>
              </div>
            </Section>

            <Section title="Scenario">
              <div className="flex gap-2">
                {["Base", "Bull", "Bear"].map((s) => (
                  <button
                    key={s}
                    className={classNames(
                      "px-4 py-2 rounded-lg border",
                      scenario === s ? "bg-indigo-600 text-white border-indigo-600" : "bg-white text-slate-700 border-slate-300 hover:bg-slate-100"
                    )}
                    onClick={() => setScenario(s as any)}
                  >
                    {s}
                  </button>
                ))}
              </div>
            </Section>
          </>
        )}

        {activeTab === "model" && (
          <>
            <Section title="P&L Summary (Normalized)">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                  <div className="flex justify-between"><span className="text-slate-700">Revenue</span><span className="font-semibold">{fmt.format(totalRevenueBase)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">COGS (by line)</span><span className="font-semibold">{fmt.format(totalCOGS)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Clinical labor</span><span className="font-semibold">{fmt.format(clinicalLaborCost)}</span></div>
                  <div className="flex justify-between border-t border-slate-200 mt-2 pt-2"><span className="text-slate-700">Gross profit</span><span className="font-semibold">{fmt.format(grossProfit)}</span></div>
                  <div className="mt-3 text-slate-700">Operating expenses</div>
                  <div className="flex justify-between"><span className="text-slate-700">Marketing</span><span className="font-semibold">{fmt.format(marketingCost)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Admin wages</span><span className="font-semibold">{fmt.format(adminCost)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Rent</span><span className="font-semibold">{fmt.format(rentAnnual)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Med director</span><span className="font-semibold">{fmt.format(medDirectorAnnual)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Insurance</span><span className="font-semibold">{fmt.format(insuranceAnnual)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Software</span><span className="font-semibold">{fmt.format(softwareAnnual)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Utilities</span><span className="font-semibold">{fmt.format(utilitiesAnnual)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Other opex</span><span className="font-semibold">{fmt.format(otherOpexCost)}</span></div>
                  <div className="flex justify-between border-t border-slate-200 mt-2 pt-2"><span className="text-slate-700">EBITDA (reported)</span><span className={classNames("font-semibold", ebitdaReported >= 0 ? "text-emerald-700" : "text-rose-600")}>{fmt.format(ebitdaReported)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Add-backs</span><span className="font-semibold">{fmt.format(ownerAddBack + otherAddBack)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">EBITDA (normalized)</span><span className={classNames("font-semibold", ebitdaNormalized >= 0 ? "text-emerald-700" : "text-rose-600")}>{fmt.format(ebitdaNormalized)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">D&A</span><span className="font-semibold">{fmt.format(daAnnual)}</span></div>
                  <div className="flex justify-between border-t border-slate-200 mt-2 pt-2"><span className="text-slate-700">EBIT (normalized)</span><span className="font-semibold">{fmt.format(ebitNormalized)}</span></div>
                </div>
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                  <div className="flex justify-between"><span className="text-slate-700">Tax rate</span><span className="font-semibold">{pct(taxRate)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">NOPAT</span><span className="font-semibold">{fmt.format(nopat)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Maintenance capex</span><span className="font-semibold">{fmt.format(maintCapex)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Owner earnings</span><span className="font-semibold">{fmt.format(ownerEarnings)}</span></div>
                  <div className="flex justify-between border-t border-slate-200 mt-2 pt-2"><span className="text-slate-700">Adjusted earnings ({epvMethod})</span><span className="font-semibold">{fmt.format(adjustedEarnings)}</span></div>
                  <div className="mt-3 text-slate-700">Working capital requirement (for reproduction)</div>
                  <div className="flex justify-between"><span className="text-slate-700">A/R</span><span className="font-semibold">{fmt.format(ar)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Inventory</span><span className="font-semibold">{fmt.format(inv)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">A/P</span><span className="font-semibold">{fmt.format(ap)}</span></div>
                  <div className="flex justify-between border-t border-slate-200 mt-2 pt-2"><span className="text-slate-700">Net working capital</span><span className="font-semibold">{fmt.format(nwcRequired)}</span></div>
                </div>
              </div>
            </Section>
          </>
        )}

        {activeTab === "valuation" && (
          <>
            <Section title="EPV Valuation (Scenario)">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                  <div className="flex justify-between"><span className="text-slate-700">Revenue (scenario)</span><span className="font-semibold">{fmt.format(totalRevenue)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Adjusted earnings</span><span className="font-semibold">{fmt.format(adjustedEarningsScenario)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">WACC (scenario)</span><span className="font-semibold">{pct(scenarioWacc)}</span></div>
                  <div className="flex justify-between border-t border-slate-200 mt-2 pt-2"><span className="text-slate-700">Enterprise EPV</span><span className="font-semibold text-emerald-700">{fmt.format(enterpriseEPV)}</span></div>
                </div>
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                  <div className="flex justify-between"><span className="text-slate-700">Cash & equivalents</span><span className="font-semibold">{fmt.format(cashNonOperating)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Debt</span><span className="font-semibold">{fmt.format(debtInterestBearing)}</span></div>
                  <div className="flex justify-between border-t border-slate-200 mt-2 pt-2"><span className="text-slate-700">Equity value (EPV)</span><span className="font-semibold text-indigo-700">{fmt.format(equityEPV)}</span></div>
                  <div className="flex justify-between mt-2"><span className="text-slate-700">EV / Revenue</span><span className="font-semibold">{evToRevenue.toFixed(2)}x</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">EV / EBITDA</span><span className="font-semibold">{evToEbitda.toFixed(2)}x</span></div>
                </div>
              </div>
            </Section>

            <Section title="Asset Reproduction & Franchise">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                  <div className="flex justify-between"><span className="text-slate-700">Buildout & improvements</span><span className="font-semibold">{fmt.format(buildoutImprovements)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Devices & equipment</span><span className="font-semibold">{fmt.format(equipmentDevices)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">FF&E</span><span className="font-semibold">{fmt.format(ffne)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Startup intangibles</span><span className="font-semibold">{fmt.format(startupIntangibles)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Other reproduction cost</span><span className="font-semibold">{fmt.format(otherRepro)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Net working capital</span><span className="font-semibold">{fmt.format(nwcRequired)}</span></div>
                  <div className="flex justify-between border-t border-slate-200 mt-2 pt-2"><span className="text-slate-700">Enterprise Reproduction Value</span><span className="font-semibold">{fmt.format(enterpriseRepro)}</span></div>
                </div>
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                  <div className="flex justify-between"><span className="text-slate-700">Equity (Reproduction)</span><span className="font-semibold">{fmt.format(equityRepro)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Equity (EPV)</span><span className="font-semibold">{fmt.format(equityEPV)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-700">Franchise factor (EV / Repro)</span><span className="font-semibold">{franchiseRatio.toFixed(2)}x</span></div>
                  <div className="mt-3">
                    <label className="text-sm text-slate-700">Recommended method</label>
                    <div className="flex flex-wrap gap-2 mt-2">
                      {(["EPV Only", "Asset Reproduction", "Conservative: Min", "Opportunistic: Max", "Blend: 70% EPV / 30% Asset"] as RecommendedMethod[]).map((m) => (
                        <button
                          key={m}
                          onClick={() => setRecoMethod(m)}
                          className={classNames(
                            "px-3 py-2 rounded-lg border",
                            recoMethod === m ? "bg-indigo-600 text-white border-indigo-600" : "bg-white text-slate-700 border-slate-300 hover:bg-slate-100"
                          )}
                        >
                          {m}
                        </button>
                      ))}
                    </div>
                  </div>
                  <div className="flex justify-between border-t border-slate-200 mt-3 pt-2"><span className="text-slate-700">Recommended Equity Value</span><span className="font-semibold text-indigo-700">{fmt.format(recommendedEquity)}</span></div>
                </div>
              </div>
            </Section>
          </>
        )}

        {activeTab === "analytics" && (
          <>
            <Section title="Valuation Sensitivity (Equity, $)">
              <div className="overflow-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr>
                      <th className="py-2 pr-4 text-left text-slate-600">WACC → / EBIT margin ↓</th>
                      {waccRange.map((w) => (
                        <th key={w} className="py-2 px-2 text-right text-slate-600">{(w * 100).toFixed(1)}%</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {ebitMarginRange.map((m) => (
                      <tr key={m} className="border-t border-slate-200">
                        <td className="py-2 pr-4 text-slate-700">{(m * 100).toFixed(1)}%</td>
                        {waccRange.map((w) => (
                          <td key={`${m}-${w}`} className="py-2 px-2 text-right font-medium">
                            {fmt2.format(epvAt(m, w))}
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </Section>

            <Section title="Scenario Overview">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div className="bg-white border border-slate-200 rounded-lg p-4">
                  <div className="text-slate-500">Base case</div>
                  <div className="mt-2 flex justify-between"><span>Revenue</span><span className="font-semibold">{fmt.format(totalRevenueBase)}</span></div>
                  <div className="flex justify-between"><span>EBIT margin</span><span className="font-semibold">{pct(ebitMargin)}</span></div>
                  <div className="flex justify-between"><span>WACC</span><span className="font-semibold">{pct(baseWacc)}</span></div>
                </div>
                <div className="bg-white border border-slate-200 rounded-lg p-4">
                  <div className="text-slate-500">Scenario adjustments</div>
                  <div className="mt-2 flex justify-between"><span>Revenue x</span><span className="font-semibold">{scenarioAdj.revenue.toFixed(2)}x</span></div>
                  <div className="flex justify-between"><span>EBIT x</span><span className="font-semibold">{scenarioAdj.ebitAdj.toFixed(2)}x</span></div>
                  <div className="flex justify-between"><span>WACC shift</span><span className="font-semibold">{pct(scenarioAdj.waccAdj)}</span></div>
                </div>
                <div className="bg-white border border-slate-200 rounded-lg p-4">
                  <div className="text-slate-500">Scenario results</div>
                  <div className="mt-2 flex justify-between"><span>Enterprise EPV</span><span className="font-semibold">{fmt.format(enterpriseEPV)}</span></div>
                  <div className="flex justify-between"><span>Equity (EPV)</span><span className="font-semibold">{fmt.format(equityEPV)}</span></div>
                  <div className="flex justify-between"><span>EV / EBITDA</span><span className="font-semibold">{evToEbitda.toFixed(2)}x</span></div>
                </div>
              </div>
            </Section>
          </>
        )}

        {activeTab === "montecarlo" && (
          <>
            <Section title="Monte Carlo (No growth, EPV)">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <LabeledNumber label="Runs" value={mcRuns} onChange={setMcRuns} step={50} help="100 - 5000" />
                <button className="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700" onClick={runMonteCarlo}>Run simulation</button>
                {mcStats && (
                  <div className="text-sm bg-slate-50 border border-slate-200 rounded-lg p-4">
                    <div className="font-semibold text-slate-800">Enterprise Value</div>
                    <div className="flex justify-between"><span>Mean</span><span className="font-semibold">{fmt.format(mcStats.mean)}</span></div>
                    <div className="flex justify-between"><span>Median</span><span className="font-semibold">{fmt.format(mcStats.median)}</span></div>
                    <div className="flex justify-between"><span>5th - 95th</span><span className="font-semibold">{fmt.format(mcStats.p5)} - {fmt.format(mcStats.p95)}</span></div>
                    <div className="font-semibold text-slate-800 mt-3">Equity Value</div>
                    <div className="flex justify-between"><span>Mean</span><span className="font-semibold">{fmt.format(mcStats.meanEquity)}</span></div>
                    <div className="flex justify-between"><span>5th - 95th</span><span className="font-semibold">{fmt.format(mcStats.p5Equity)} - {fmt.format(mcStats.p95Equity)}</span></div>
                  </div>
                )}
              </div>
              {!mcStats && <div className="text-slate-600 text-sm mt-3">Tip: Increase runs for smoother statistics. EPV uses zero growth by definition.</div>}
            </Section>
          </>
        )}

        {activeTab === "lbo" && (
          <>
            <Section title="LBO Quick Check (Constant EPV earnings)">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <DollarsField label="Entry EV (override)" value={entryEvOverride ?? 0} onChange={(v) => setEntryEvOverride(v === 0 ? null : v)} help="Leave 0 to use EPV" />
                <PercentField label="Entry debt % of EV" value={entryDebtPct} onChange={setEntryDebtPct} />
                <LabeledNumber label="Hold years" value={lboYears} onChange={setLboYears} step={1} />
              </div>
              <div className="mt-3 flex items-center gap-2">
                <span className="text-sm text-slate-700">Exit EV basis:</span>
                <button
                  className={classNames("px-3 py-2 rounded-lg border", exitMultipleMode === "EPV" ? "bg-indigo-600 text-white border-indigo-600" : "bg-white text-slate-700 border-slate-300")}
                  onClick={() => setExitMultipleMode("EPV")}
                >
                  EPV (scenario)
                </button>
                <button
                  className={classNames("px-3 py-2 rounded-lg border", exitMultipleMode === "Same EV" ? "bg-indigo-600 text-white border-indigo-600" : "bg-white text-slate-700 border-slate-300")}
                  onClick={() => setExitMultipleMode("Same EV")}
                >
                  Same as entry
                </button>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm mt-4">
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                  <div className="text-slate-500">Entry</div>
                  <div className="flex justify-between"><span>EV</span><span className="font-semibold">{fmt.format(entryEV)}</span></div>
                  <div className="flex justify-between"><span>Debt</span><span className="font-semibold">{fmt.format(entryDebt)}</span></div>
                  <div className="flex justify-between"><span>Equity</span><span className="font-semibold">{fmt.format(entryEquity)}</span></div>
                </div>
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                  <div className="text-slate-500">Exit</div>
                  <div className="flex justify-between"><span>EV</span><span className="font-semibold">{fmt.format(lboExitEV)}</span></div>
                  <div className="flex justify-between"><span>Debt</span><span className="font-semibold">{fmt.format(lboSim.exitDebt)}</span></div>
                  <div className="flex justify-between"><span>Equity</span><span className="font-semibold">{fmt.format(lboSim.exitEquity)}</span></div>
                </div>
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                  <div className="text-slate-500">Returns</div>
                  <div className="flex justify-between"><span>MOIC</span><span className="font-semibold">{lboSim.moic.toFixed(2)}x</span></div>
                  <div className="flex justify-between"><span>IRR</span><span className="font-semibold">{(lboSim.irr * 100).toFixed(1)}%</span></div>
                </div>
              </div>
            </Section>
          </>
        )}

        {activeTab === "notes" && (
          <>
            <Section title="Modeling Notes & Assumptions">
              <div className="prose prose-sm max-w-none text-slate-700">
                <ul className="list-disc pl-6">
                  <li>Greenwald EPV values the steady-state earning power with zero growth. Adjusted earnings can be modeled as NOPAT or Owner Earnings (NOPAT + D&A - Maintenance Capex).</li>
                  <li>WACC is built from CAPM (risk-free + beta × ERP) plus size/specific premia and after-tax cost of debt weighted by a target capital structure.</li>
                  <li>Reproduction value estimates the capital required to replicate the clinic today (buildout, equipment, FF&E, startup intangibles) plus working capital.</li>
                  <li>Franchise factor (EPV ÷ Reproduction) indicates moat: &gt;1.0 suggests returns exceed cost of capital.</li>
                  <li>Medispa nuances: high cash-pay mix (low DSO), meaningful consumables (injectables), device refresh needs (maintenance capex), and provider revenue sharing (clinical labor %).</li>
                  <li>Sensitivity and Monte Carlo explore uncertainty in WACC, margin, and capital intensity; results are not investment advice.</li>
                </ul>
              </div>
            </Section>
          </>
        )}

        <footer className="mt-10 text-center text-slate-500 text-xs">
          Built for private equity-grade analysis. For education only; not investment advice.
        </footer>
      </div>
    </div>
  );
}